# 更新日志

## [v0.3] - 2026-02-14

### 🎉 重大重构

这是一个完全重构的版本，解决了 v0.2 版本的所有已知问题。

### ✨ 新增功能

- 新增分页功能，支持查看大量回声洞记录
- 新增完整的配置系统，所有文案可自定义
- 新增软删除机制，保留数据完整性
- 新增查看次数统计功能
- 新增合并消息转发支持（搜索结果）
- 新增自动降级策略（转发失败时逐条发送）

### 🔧 改进优化

#### 数据库层面
- 移除哨兵记录设计，使用 AUTOINCREMENT 管理 ID
- 使用 `is_deleted` 字段替代文本覆盖删除
- 添加数据库索引，提升查询性能
- 在 SQL 层实现分页和限制，优化内存使用
- 使用上下文管理器确保数据库连接正确关闭

#### 代码质量
- 完善错误处理，所有数据库操作包裹 try/except
- 消除所有魔法字符串，全部移入配置文件
- 使用规范的数据目录路径
- 添加详细的日志记录
- 代码结构优化，提高可维护性

#### 功能增强
- mycave 命令支持四种参数模式
- 添加内容长度限制（默认 200 字）
- 搜索结果限制在配置的页面大小内
- 页码越界检查，防止数组越界
- 参数验证更加严格

### 🐛 修复问题

- 修复并发添加时可能出现的 ID 重复问题
- 修复删除判断逻辑依赖魔法字符串的问题
- 修复 mycave 命令可能导致消息过长的问题
- 修复搜索时内存占用过大的问题
- 修复路径拼接在不同平台的兼容性问题
- 修复配置缺失时的崩溃问题

### 📝 配置变更

新增配置项：
- `max_content_length`：内容最大长度
- `page_size`：每页显示数量
- `messages`：完整的消息文案配置对象

### 🔄 数据库变更

**重要**：从 v0.2 升级需要迁移数据（但我并没有想好怎么迁移）

数据库结构变更：
- 移除 `cave_id = 0` 的哨兵记录
- 新增 `is_deleted` 字段（INTEGER，0=未删除，1=已删除）
- 新增索引：`idx_sender`、`idx_deleted`

迁移步骤：
1. 备份原数据库文件
2. 更新插件到 v0.3
3. 旧数据中标记为"此回声洞已被删除"的记录需手动设置 `is_deleted = 1`

### ⚠️ 破坏性变更

- 配置文件结构变更，需要重新配置
- 数据库结构变更，需要迁移数据
- mycave 命令参数解析逻辑变更

### 📚 文档更新

- 新增完整的 README.md
- 新增 CHANGELOG.md
- 配置文件添加详细的说明和提示

---

## [v0.2] - 2026-02-13

### 🎉 首次发布

- 基础的回声洞功能
- 支持添加、查看、随机、搜索、删除操作
- 基于 SQLite3 存储
- 支持 NapCat + AstrBot 4.9+

### 已知问题

- 使用哨兵记录管理 ID，可读性差
- 存在并发竞态风险
- 硬编码漫天乱飞
- 缺少分页功能
- 缺少输入验证
- 错误处理不足
